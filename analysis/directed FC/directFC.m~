function [DFC, mDFC] = directFC(SSmodel, connect, CROI, fres)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Compute directed functional connectivity on a sliding window according to
% diferent mode of connectivity (inter, intra and pairwise channel)
%%%%%%%%%%%%%%%%%%%%%
%%% Input parameters: 
% -SSmodel : State space model on slided time series. SSmodel is a structure
%           with fields : A,V,C,K, model order and spectral radius
% -connect : intra/inter/group
% -CROI : {xchans1-xchans2/x/group
%%%%%%%%%%%%%%%%%%%%%
%%% Output 
% - DFC: directed functional connectivity on slided window
% - mDFC: mean directed functional connectivity along sliding window
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

nwin = size(SSmodel,2);
DFC = zeros(nwin,1);

for w = 1:nwin
    switch connect
        case 'inter'
            DFC(w) = ss_to_mvgc(SSmodel(w).A,SSmodel(w).C,SSmodel(w).K, ...
            SSmodel(w).V, CROI{1}, CROI{2});
        case 'intra'
            DFC(w) = ss_to_cggc(SSmodel(w).A,SSmodel(w).C,SSmodel(w).K, ... 
            SSmodel(w).V, CROI);
    end
end

mDFC = mean(DFC,1);
